<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cadernos — App</title>
  <link rel="stylesheet" href="cadernos.css">
  <link rel="icon" type="image/x-icon" href="Assets/logoicon.ico">
</head>
<body>
  <div class="container">

    <aside class="sidebar">
      <img src="Assets/logoM.png" class="logo" alt="logo">

      <nav class="menu">
        <button class="menu-item home" aria-label="Início"></button>
        <button class="menu-item calendar" aria-label="Calendário"></button>
        <button class="menu-item notes" aria-label="Notas"></button>
        <button class="menu-item list" aria-label="Listas"></button>
        <button class="menu-item user" aria-label="Perfil"></button>
      </nav>
    </aside>

    <main class="main">

      <header class="top-bar">
        <h1 class="title">Cadernos</h1>
        <div class="actions">
          <button class="btn delete" onclick="excluirCaderno()">Excluir</button>
          <button class="btn save" onclick="salvarCaderno()">Salvar</button>
        </div>
      </header>

      <section class="editor-area">
            <div id="texto" class="editor" contenteditable="true" aria-label="Editor de texto"></div>
            <textarea id="htmlRaw" hidden></textarea>
      </section>

      <div class="toolbar" role="toolbar" aria-label="Barra de formatação">
        <button class="tool align-left" onmousedown="bold(1, this)"></button>
        <button class="tool align-center" onmousedown="bold(2, this)" ></button>
        <button class="tool align-right" onmousedown="bold(3, this)" ></button>
        <button class="tool align-justify" onmousedown="bold(4, this)" ></button>

        <button class="tool bold" onmousedown="bold(5, this)" ></button>
        <button class="tool italic" onmousedown="bold(6, this)" ></button>
        <button class="tool underline" onmousedown="bold(7, this)" ></button>

        <button class="tool color" onclick="toggleColorPicker()"></button>
        <div id="mostraCores" class="color-picker hidden">
           <div class="color-option" style="background: red;"></div>
          <div class="color-option" style="background: blue;"></div>
          <div class="color-option" style="background: green;"></div>
          <div class="color-option" style="background: yellow;"></div>
          <div class="color-option" style="background: black;"></div>
        </div>
        <button class="tool bullet" onclick="bold(8)"></button>
         <select onchange="setFontSize(this.value)" title="Tamanho">
          <option value="">Tamanho</option>
          <option value="1">10px</option>
          <option value="2">13px</option>
          <option value="3">16px</option>
          <option value="4">18px</option>
          <option value="5">24px</option>
        </select>
      </div>

    </main>

  </div>

  <script>
    document.querySelector('.editor').addEventListener('keydown', function(e){
      if(e.key === 'Tab'){
        e.preventDefault();
      }
    });

    
  </script>
  <script>
    let cadernoAtual = null;
    const urlParams = new URLSearchParams(window.location.search);

    const idUsuario = urlParams.get("idUsuario");

  const btnHome = document.querySelector(".menu-item.home");
  const btnCalendar = document.querySelector(".menu-item.calendar");
  const btnNotes = document.querySelector(".menu-item.notes");
  const btnList = document.querySelector(".menu-item.list");
  const btnUser = document.querySelector(".menu-item.user");

   btnHome.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/home-page/home-page.html?idUsuario=${idUsuario}`;
  });

  btnCalendar.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/calendario/calendario.html?idUsuario=${idUsuario}`;
  });

  btnNotes.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/caderno/caderno.html?idUsuario=${idUsuario}`;
  });

  btnList.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/tarefas/tarefas.html?idUsuario=${idUsuario}`;
  });
    

    const activeFormats = {
      bold: false,
      italic: false,
      underline: false,
      color: null
    };

// Referências
const editor = document.getElementById("texto");
const htmlRaw = document.getElementById("htmlRaw");
const picker = document.getElementById("mostraCores");
let activeColor = null; 

  function toggleFormat(type, button) {
    activeFormats[type] = !activeFormats[type];
    if (button) {
      button.classList.toggle("active", activeFormats[type]);
    }
  }


function getSelectedRange() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return null;
    return sel.getRangeAt(0);
}



function updateRawHtml() {
    htmlRaw.value = editor.innerHTML; // passa o texto para html puro
}

editor.addEventListener("input", updateRawHtml); // atualiza ao digitar

editor.addEventListener("beforeinput", function (e) {
    if (e.inputType === "insertText") {
        e.preventDefault();
        
        let char = e.data;

        if (activeFormats.bold) char = `<b>${char}</b>`;
        if (activeFormats.italic) char = `<i>${char}</i>`;
        if (activeFormats.underline) char = `<u>${char}</u>`;
        if (activeFormats.size) char = `<span style="font-size:${activeFormats.size}px">${char}</span>`;
        if (activeFormats.color) char = `<span style="color:${activeFormats.color}">${char}</span>`;
        insertHtmlAtCursor(char);
    }
});
// ======================================================
// Função principal que insere HTML manualmente
// ======================================================
function insertHtmlAroundSelection(before, after) {
    const range = getSelectedRange();
    if (!range) return;

    const selectedText = range.toString(); // texto selecionado

    // cria o HTML manualmente
    const wrapper = document.createElement("span"); // wrapper temporário
    wrapper.innerHTML = before + selectedText + after; // insere o HTML

    // remove seleção atual
    range.deleteContents(); // apaga o conteúdo selecionado
    range.insertNode(wrapper); // insere o novo nó com formatação

    updateRawHtml();
}



function bold(type, button) {
  editor.focus();

    switch (type) {

        case 1: // Alinhar esquerda
            editor.style.textAlign = "left";
            break;

        case 2: // centro
            editor.style.textAlign = "center";
            break;

        case 3: // direita
            editor.style.textAlign = "right";
            break;

        case 4: // justificar
            editor.style.textAlign = "justify";
            break;

        case 5: toggleFormat("bold", button); break;
        case 6: toggleFormat("italic",button); break;
        case 7: toggleFormat("underline", button); break;

        case 8: // list
             insertHtmlAroundSelection("<ul><li>", "</li></ul>");
            break;

        default:
            console.log("Formato não reconhecido");
    }

    updateRawHtml();
}


function setFontSize(value) {
     const map = {
        "1": 10,
        "2": 13,
        "3": 16,
        "4": 18,
        "5": 24
    };

    activeFormats.size = map[value] || null;
    updateRawHtml();
}
  function applyColor(color) {
   activeFormats.color = color;
}

function insertHtmlAtCursor(html) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    range.deleteContents();

    const temp = document.createElement("span");
    temp.innerHTML = html;

    const node = temp.firstChild;

    range.insertNode(node);

    range.setStartAfter(node);
    range.setEndAfter(node);
    sel.removeAllRanges();
    sel.addRange(range);

    updateRawHtml();
}

  function toggleColorPicker() {
    picker.classList.toggle("hidden");
}


picker.addEventListener("click", function(e) {
    if (e.target.classList.contains("color-option")) {

        // pega a cor do botão
        const cor = e.target.style.background;

        // aplica no formato ativo
        activeFormats.color = cor;

        // fecha o seletor
        picker.classList.add("hidden");
    }
});

function insertList() {
    const range = getSelectedRange();
    if (!range) return;

    const selectedText = range.toString() || "item"; 

    const ul = document.createElement("ul");
    const li = document.createElement("li");
    li.textContent = selectedText;
    ul.appendChild(li);

    
    range.deleteContents();
    
    // insere a <ul>
    range.insertNode(ul);

    updateRawHtml();
}
  
  const parametros = new URLSearchParams(window.location.search);

  const id_caderno = parametros.get("id");
  const statusCaderno = "RASCUNHO";

  async function salvarCaderno() {
    const conteudo = editor.innerHTML;

    if (!cadernoAtual.titulo_caderno || cadernoAtual.titulo_caderno.trim() === "") {
    console.log(cadernoAtual);
    alert("O título do caderno é obrigatório");
    return;
    }

    try {
        const response = await fetch(`http://localhost:8080/cadernos/${id_caderno}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                titulo_caderno: cadernoAtual.titulo_caderno,
                conteudo: conteudo,   
                status_caderno: statusCaderno,
                id_usuario : {
                  id : cadernoAtual.id_usuario
                }             
            })
        });

        if (!response.ok) {
            const erroTexto = await response.text();
            console.error("Erro do backend:", erroTexto);
            alert("Erro ao salvar: " + erroTexto);
            return;
        }

        const contentType = response.headers.get("content-type");

        if (contentType && contentType.includes("application/json")) {
          const resultado = await response.json();
          console.log("Salvo com sucesso:", resultado);
        } else {
          const texto = await response.text();
          console.warn("Resposta não JSON:", texto);
        }

alert("Salvo com sucesso!");

    } catch (error) {
        console.error("Erro ao salvar:", error);
        alert("Erro ao salvar.");
    }
}

async function excluirCaderno() {
    try {
        const resposta = await fetch(`http://localhost:8080/cadernos/${id_caderno}`, {
            method: "DELETE"
        });

        if (!resposta.ok) {
            // Erro retornado pela API
            alert("Erro ao excluir (API retornou erro).");
            return;
        }

        alert("Documento excluído!");
        window.location.href = `/src/app/componentes/caderno/caderno.html?idUsuario=${idUsuario}`;

    } catch (erro) {
        // Erro de rede, servidor offline, etc
        console.error("Erro ao conectar com API:", erro);
        alert("Não foi possível conectar ao servidor.");
    }
}

async function carregarCaderno() {
  if (!id_caderno) return;

  try {
    const response = await fetch(
      `http://localhost:8080/cadernos/${id_caderno}`
    );

    if (!response.ok) {
      throw new Error("Erro ao buscar caderno");
    }

    const caderno = await response.json();

    cadernoAtual = caderno;


    if (caderno.conteudo) {
      editor.innerHTML = caderno.conteudo;
      updateRawHtml();
    }
    
    return caderno;
  } catch (erro) {
    console.error("Erro ao carregar caderno:", erro);
    alert("Erro ao carregar o caderno.");
  }
}

  document.addEventListener("DOMContentLoaded", function() {
    carregarCaderno();

  });
</script>

</body>
</html>

