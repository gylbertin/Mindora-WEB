<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendário</title>
  <link rel="stylesheet" href="calendario.css" />
  <link rel="icon" type="image/x-icon" href="Assets/logoicon.ico">
</head>
<body>

  <aside class="sidebar">
    <img src="Assets/logoM.png" alt="logo" class="logo">

    <nav class="menu" aria-label="Menu principal">
      <button class="menu-item home" aria-label="Início"></button>
      <button class="menu-item calendar active" aria-label="Calendário"></button>
      <button class="menu-item notes" aria-label="Notas"></button>
      <button class="menu-item list" aria-label="Listas"></button>
      <button class="menu-item user" aria-label="Perfil"></button>
    </nav>
  </aside>

  <main class="content">
    <header class="topbar">
      <h1 class="page-title">Calendário</h1>

      <div class="right-controls">
        <select id="monthSelect" class="month-pill" aria-label="Mês"></select>
        <input id="yearInput" class="year-box" type="number" value="2025" aria-label="Ano" />
      </div>
    </header>

    <section id="calendarCard" class="calendar-wrapper card" tabindex="0" aria-label="Calendário">
      <div class="weekdays" aria-hidden="true">
        <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
      </div>

      <div id="monthGrid" class="month-grid" role="grid" aria-live="polite">
      </div>
    </section>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);

    const idUsuario = urlParams.get("idUsuario");

  document.addEventListener("DOMContentLoaded", function() {
  const btnHome = document.querySelector(".menu-item.home");
  const btnCalendar = document.querySelector(".menu-item.calendar");
  const btnNotes = document.querySelector(".menu-item.notes");
  const btnList = document.querySelector(".menu-item.list");
  const btnUser = document.querySelector(".menu-item.user");
    

   btnHome.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/home-page/home-page.html?idUsuario=${idUsuario}`;
  });

  btnCalendar.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/calendario/calendario.html?idUsuario=${idUsuario}`;
  });

  btnNotes.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/caderno/caderno.html?idUsuario=${idUsuario}`;
  });

  btnList.addEventListener("click", () => {
    window.location.href = `/src/app/componentes/barra-lateral/tarefas/tarefas.html?idUsuario=${idUsuario}`;
  });

  });

    const monthNames = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

     async function  buscarTarefas(ano, mes) {
      const response = await fetch(`http://localHost:8080/tarefas/usuario/${idUsuario}?ano=${ano}&mes=${mes + 1}`);
     
      if (!response.ok) {
        console.error("Erro ao buscar tarefas");
        return [];
      }

      return await response.json();
    }

    function agruparPorDiaComMaiorPrioridade(tarefas) {
      const mapa = {};

      tarefas.forEach(t => {
        const data = new Date(t.dataVencimento);
        const dia = data.getDate();

        if (!mapa[dia]) {
          mapa[dia] = t;
        } else {
          if (t.prioridade > mapa[dia].prioridade) {
            mapa[dia] = t;
          }
        }
      });

      return mapa;
    }

    function corPorPrioridade (prioridade) {
      if (prioridade >= 3) return "red";
      if (prioridade === 2) return "orange";
      if (prioridade === 1) return "blue";
    }

    const monthSelect = document.getElementById('monthSelect');
    const yearInput = document.getElementById('yearInput');
    const monthGrid = document.getElementById('monthGrid');
    const calendarCard = document.getElementById('calendarCard');

    monthNames.forEach((m, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = m;
      monthSelect.appendChild(opt);
    });

    let activeYear = parseInt(yearInput.value, 10) || (new Date()).getFullYear();
    let activeMonth = 0;
    monthSelect.value = activeMonth;

    function daysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
    function firstWeekdayOfMonth(year, month) { return new Date(year, month, 1).getDay(); }
    function key(year, month){ return `${year}-${month}`; }

    function createEventBar(ev){
      const bar = document.createElement('div');
      bar.className = 'event-bar ' + ev.color + (ev.length === 'small' ? ' small' : '');
      if(ev.lefted) bar.classList.add('lefted');
      return bar;
    }

    function createEventTag(ev){
      const tagWrap = document.createElement('div');
      tagWrap.className = 'event-tag-wrap';

      const status = document.createElement('button');
      status.className = 'event-status';
      status.setAttribute('aria-label','Marcar como concluído');
      if(ev.done) status.setAttribute('data-done','true');
      else status.setAttribute('data-done','false');

      status.innerHTML = `<svg viewBox="0 0 24 24" class="status-icon" width="14" height="14" aria-hidden="true">
        <path class="check" d="M20.285 6.708a1 1 0 0 0-1.44-1.39l-8.07 8.16-3.14-3.17a1 1 0 1 0-1.42 1.42l3.86 3.9a1 1 0 0 0 1.42 0l8.79-8.91z"/>
        <circle class="circle" cx="12" cy="12" r="9" fill="none" stroke-width="0"></circle>
      </svg>`;

      const label = document.createElement('div');
      label.className = 'event-label';
      label.textContent = ev.tag || '';

      tagWrap.appendChild(status);
      tagWrap.appendChild(label);

      status.addEventListener('click', (e) => {
        e.stopPropagation();
        const current = status.getAttribute('data-done') === 'true';
        status.setAttribute('data-done', current ? 'false' : 'true');
      });

      return tagWrap;
    }

    function renderCalendar(year, month){
      monthGrid.innerHTML = '';
      monthSelect.value = month;
      yearInput.value = year;

      const firstWeekday = firstWeekdayOfMonth(year, month);
      const totalDays = daysInMonth(year, month);
      
      for(let p=0;p<7;p++){
        const placeholder = document.createElement('div');
        placeholder.className = 'day placeholder';
        monthGrid.appendChild(placeholder);
      }

      const leading = firstWeekday;
      const requiredCells = (leading + totalDays) > 35 ? 42 : 35;

      for(let i=0;i<requiredCells;i++){
        const cell = document.createElement('div');
        cell.className = 'day';
        const idx = i - leading + 1;
        if(idx < 1 || idx > totalDays){
          cell.classList.add('empty');
        } else {
          const span = document.createElement('span');
          span.className = 'date';
          span.textContent = String(idx).padStart(2,'0');
          cell.appendChild(span);
        }
        monthGrid.appendChild(cell);
      }

      const currentCount = monthGrid.children.length;
      if(currentCount < 49){
        const need = 49 - currentCount;
        for(let k=0;k<need;k++){
          const cell = document.createElement('div');
          cell.className = 'day empty';
          monthGrid.appendChild(cell);
        }
      }

      buscarTarefas(year, month).then(tarefas => {
        const tarefasPorDia = agruparPorDiaComMaiorPrioridade(tarefas);

        Object.values(tarefasPorDia).forEach(tarefa => {
          const data = new Date(tarefa.dataVencimento);
          const dia = String(data.getDate()).padStart(2,'0');

          const dateSpans = monthGrid.querySelectorAll('.date');

          for(const ds of dateSpans) {
            if (ds.textContent === dia) {
              const cell = ds.closest('.day');

              const ev = {
                color: corPorPrioridade(tarefa.prioridade),
                length: "normal",
                done: tarefa.statusTarefa === "REALIZADO",
                tag: tarefa.tituloTarefa
              };

              const bar = createEventBar(ev);
              const tag = createEventTag(ev);

              cell.appendChild(bar);
              cell.appendChild(tag);
              break;
            }
          }
        })
      });

    }

    function changeMonth(delta){
      activeMonth += delta;
      if(activeMonth < 0){ activeMonth = 11; activeYear--; }
      else if(activeMonth > 11){ activeMonth = 0; activeYear++; }
      renderCalendar(activeYear, activeMonth);
    }

    calendarCard.addEventListener('wheel', (e) => {
      e.preventDefault();
      if (e.deltaY > 0) changeMonth(1);
      else if (e.deltaY < 0) changeMonth(-1);
    }, { passive:false });

    calendarCard.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowLeft') changeMonth(-1);
      if(e.key === 'ArrowRight') changeMonth(1);
    });

    monthSelect.addEventListener('change', ()=> {
      activeMonth = parseInt(monthSelect.value,10);
      renderCalendar(activeYear, activeMonth);
    });
    yearInput.addEventListener('change', ()=> {
      const v = parseInt(yearInput.value,10);
      if(!isNaN(v)){
        activeYear = v;
        renderCalendar(activeYear, activeMonth);
      }
    });

    (function init(){
      const now = new Date();
      activeYear = now.getFullYear();
      activeMonth = now.getMonth();
      monthSelect.value = activeMonth;
      yearInput.value = activeYear;
      renderCalendar(activeYear, activeMonth);
    })();
  </script>
</body>
</html>